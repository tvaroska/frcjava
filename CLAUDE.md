# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an FRC (FIRST Robotics Competition) 2025 Java robot project using WPILib's command-based framework with a swerve drive system powered by CTRE Phoenix 6 hardware (TalonFX motors and CANcoders).

### Vendor Dependencies

Required vendordeps (located in `vendordeps/`):
- **Phoenix6-frc2025-latest.json** - CTRE Phoenix 6 library for TalonFX motors, CANcoders, and Pigeon 2
- **photonlib.json** - PhotonVision library for AprilTag detection and vision processing
- **AdvantageKit.json** - AdvantageKit for advanced telemetry and logging (installed but not actively used)
- **WPILibNewCommands.json** - WPILib command-based framework

## Essential Commands

### Build and Deploy
- `./gradlew build` - Compile and run tests
- `./gradlew deploy` - Build and deploy code to the RoboRIO
- `./gradlew clean` - Clean build artifacts

### Testing
- `./gradlew test` - Run JUnit 5 tests
  - Tests located in `src/test/java/frc/robot/`
  - Test coverage: 22 tests across 5 test files
    - RobotContainerTest (robot initialization)
    - TelemetryTest (telemetry publishing)
    - VisionSubsystemTest (vision subsystem functionality)
    - DriveToTagTest (vision-guided driving command)
    - VisionGuidedDrivingTest (integration tests)

### Simulation
- `./gradlew simulateJava` - Run robot code in simulation with GUI enabled by default
- Driver Station is automatically added to simulation

### Useful Tools
- `./gradlew SysId` - Launch WPILib's System Identification tool for characterization
- `./gradlew Glass` - Launch Glass for telemetry visualization
- `./gradlew ShuffleBoard` - Launch Shuffleboard dashboard

## Architecture

### Command-Based Structure

The project follows WPILib's command-based paradigm:

- **Robot.java** - Extends `TimedRobot`, runs command scheduler in `robotPeriodic()`
- **RobotContainer.java** - Central configuration hub: instantiates subsystems, binds controller inputs to commands
  - Subsystems accessed via getter methods (`getDrivetrain()`, `getVision()`)
  - Note: `getAutonomousCommand()` method removed - autonomous setup should be added here when needed
- **Subsystems** - Located in `frc.robot.subsystems/`:
  - `CommandSwerveDrivetrain` - Swerve drivetrain with field-centric control
  - `VisionSubsystem` - PhotonVision integration for AprilTag detection
- **Commands** - Located in `frc.robot.commands/`:
  - `DriveToTag` - Vision-guided alignment and approach to AprilTags

### Swerve Drive Implementation

The swerve drivetrain is built on CTRE Phoenix 6 libraries:

- **CommandSwerveDrivetrain** - Main subsystem extending CTRE's `SwerveDrivetrain` and WPILib's `Subsystem`
- **TunerConstants.java** (generated) - Contains hardware IDs, PID gains, gear ratios, module positions, and encoder offsets
  - Generated by Tuner X - modifications should be done via Tuner X tool
  - Creates module constants for 4 swerve modules (FrontLeft, FrontRight, BackLeft, BackRight)
- **ModuleConstants.java** - Additional module-level configuration

Hardware configuration:
- 4 swerve modules, each with TalonFX drive motor, TalonFX steer motor, CANcoder absolute encoder
- Pigeon 2 IMU (CAN ID 24) for heading
- All devices on "rio" CAN bus
- Top speed: 4.99 m/s at 12V

### Control Bindings (Xbox Controller)

Default driver controls configured in `RobotContainer.configureBindings()`:
- Left stick: Translation (X/Y movement) with slew rate limiting (3 units/sec)
- Right stick X: Rotation with slew rate limiting
- **A button**: Drive to nearest AprilTag (vision-guided alignment and approach)
- **X button**: Brake mode (point wheels in X formation)
- Right bumper: Point wheels toward stick direction
- Left bumper: Reset field-centric heading
- Back+Y/X: SysId dynamic characterization
- Start+Y/X: SysId quasistatic characterization

### Constants Organization

- **Constants.java** - Application constants organized by subsystem:
  - `OperatorConstants` - Controller port configuration
  - `DriveConstants` - Max speeds, slew rates, deadbands
  - `VisionConstants` - Camera name, PID gains, alignment tolerances
- **TunerConstants.java** - Hardware-specific swerve configuration (DO NOT manually edit - use Tuner X)

### Vision Integration

The project includes PhotonVision integration for AprilTag detection:

- **VisionSubsystem** - Manages PhotonCamera and target detection
  - Connection monitoring with automatic disconnect detection
  - SmartDashboard telemetry (connected status, target ID, yaw, area)
  - Optional-based API for null safety
  - Error handling with try-catch and DriverStation error reporting
- **DriveToTag Command** - Vision-guided alignment and approach
  - P-controller for rotation (yaw alignment)
  - P-controller for forward drive (distance control via target area)
  - Minimum speed enforcement to overcome friction
  - Sequential behavior: rotate first, then drive forward
  - All constants configurable in `VisionConstants`

Note: `CommandSwerveDrivetrain` provides `addVisionMeasurement()` methods for pose fusion, but this is not currently implemented.

## Important Development Notes

### Generated Files

Files in `frc.robot.generated/` are generated by CTRE Tuner X:
- Do not manually edit `TunerConstants.java` or `ModuleConstants.java`
- Use Tuner X to modify PID gains, module positions, gear ratios, or hardware IDs
- Re-generate after hardware changes

### Simulation

- Simulation automatically starts at 200 Hz (5ms loop period) when `Utils.isSimulation()` is true
- Simulation GUI and DriverStation are configured in `build.gradle`
- Desktop support is enabled (`includeDesktopSupport = true`)
- Common simulation warnings (can be ignored):
  - "Joystick Button X on port 0 not available" - No controller plugged in
  - "CAN frame not received/too-stale" - Simulated devices may not respond immediately
  - "Loop time overrun" - Simulation periodic taking longer than 20ms during initialization

### Alliance-Aware Operation

The drivetrain automatically adjusts operator perspective based on alliance color:
- Blue alliance: 0° is toward red wall
- Red alliance: 180° is toward blue wall
- Applied in `periodic()` when disabled or on first run

### Team Number Configuration

Team number is loaded from `.wpilib/wpilib_preferences.json` or command line, required for deployment.

### Java Version

Project requires Java 17 (source and target compatibility set in `build.gradle`).

### Telemetry

AdvantageKit is installed as a vendordep but currently not actively used (Robot extends `TimedRobot`, not `LoggedRobot`). The `Telemetry` class uses CTRE's SignalLogger for swerve drivetrain data logging via `drivetrain.registerTelemetry()`.

### Testing Strategy

The project includes comprehensive unit and integration tests (22 tests total):

**Unit Tests:**
- **RobotContainerTest** - Validates robot initialization, drivetrain setup, and command scheduler execution
- **TelemetryTest** - Verifies telemetry can publish swerve drive state without errors
- **VisionSubsystemTest** - Tests camera initialization, target detection, connection tracking, error handling
- **DriveToTagTest** - Tests command lifecycle, requirements, scheduling, cancellation

**Integration Tests:**
- **VisionGuidedDrivingTest** - Tests full system interaction: vision + drivetrain + commands + scheduler

All tests use HAL simulation and run automatically with `./gradlew test` or `./gradlew build`.

### Code Quality

The codebase follows these best practices:
- **Encapsulation**: All fields private, accessed via getters
- **Naming conventions**: Consistent camelCase throughout
- **No magic numbers**: All constants extracted to `Constants.java`
- **Error handling**: Try-catch blocks with DriverStation error reporting
- **Null safety**: Optional-based APIs instead of nullable returns
- **Performance**: Direct `setControl()` calls instead of lambda creation overhead
- **Documentation**: Comprehensive JavaDoc on all public methods
